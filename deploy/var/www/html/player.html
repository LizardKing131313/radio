<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="upgrade-insecure-requests" http-equiv="Content-Security-Policy">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.14/dist/hls.min.js"></script>

<title>–ì–æ–≤–Ω–æ–≤–æ–∑ –†–∞–¥–∏–æ</title>

<style>
  :root {
    color-scheme: dark light
  }

  body {
    margin: 0;
    background: #0b0b0b;
    color: #ddd;
    font: 16px/1.5 system-ui
  }

  main {
    max-width: 720px;
    margin: 24px auto;
    padding: 16px
  }

  h1 {
    margin: .2rem 0 1rem
  }

  audio {
    width: 100%
  }

  button {
    margin: 12px 6px 0 0;
    padding: 12px 16px;
    border: 0;
    border-radius: 10px
  }

  button:hover {
    background: #222;
    cursor: pointer;
  }
</style>

<main>
  <h1>–ì–æ–≤–Ω–æ–≤–æ–∑ –†–∞–¥–∏–æ</h1>
  <audio controls id="a" playsinline></audio>
  <div>
    <button id="play">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
    <button id="mute">üîá/üîä</button>
  </div>
</main>

<script>
  const a = document.getElementById('a');

  const ORIGIN = (location.protocol === 'https:')
    ? location.origin
    : ('https://' + location.host);

  async function start() {
    const sources = [
      '/live/mp4/playlist.m3u8', // CMAF/fMP4
      '/live/ts/playlist.m3u8'   // TS
    ];

    async function probe(pathOrUrl) {
      const u = new URL(pathOrUrl, location.origin); // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ https
      u.searchParams.set('_', Date.now());           // –¥–æ–±–∞–≤–ª—è–µ–º ?_=...
      console.log('probe ‚Üí', u.toString());          // –≤—Ä–µ–º–µ–Ω–Ω–æ: —É–±–µ–¥–∏—Å—å, —á—Ç–æ –ù–ï–¢ "/?" !
      const r = await fetch(u.toString(), {method: 'HEAD', cache: 'no-store'});
      return r.ok;
    }

    // Safari / iOS ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–π HLS
    if (a.canPlayType('application/vnd.apple.mpegurl')) {
      for (const src of sources) {
        if (await probe(src)) {
          a.src = src;
          await a.play().catch(() => {
          });
          return;
        }
      }
      console.error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö HLS –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤');
      return;
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —á–µ—Ä–µ–∑ hls.js
    if (window.Hls && Hls.isSupported()) {
      const hls = new Hls({lowLatencyMode: true, backBufferLength: 10});
      hls.attachMedia(a);

      for (const src of sources) {
        if (!(await probe(src))) continue;
        try {
          hls.loadSource(src);
          await a.play().catch(() => {
          });
          return;
        } catch {
        }
      }
      console.error('–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —É–ø–∞–ª–∏');
    }
  }

  document.getElementById('play').onclick = async () => {
    a.muted = false;
    await start();
  };

  document.getElementById('mute').onclick = () => {
    a.muted = !a.muted;
  };
</script>
