<!doctype html>
<html lang="ru">
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="upgrade-insecure-requests" http-equiv="Content-Security-Policy">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.14/dist/hls.min.js"></script>

<title>–ì–æ–≤–Ω–æ–≤–æ–∑ –†–∞–¥–∏–æ</title>

<style>
  :root {
    color-scheme: dark light
  }

  body {
    margin: 0;
    background: #0b0b0b;
    color: #ddd;
    font: 16px/1.5 system-ui
  }

  main {
    max-width: 720px;
    margin: 24px auto;
    padding: 16px
  }

  h1 {
    margin: .2rem 0 1rem
  }

  button {
    margin: 12px 6px 0 0;
    padding: 12px 16px;
    border: 0;
    border-radius: 10px
  }

  button:hover {
    background: #222;
    cursor: pointer;
  }

  audio {
    width: 100%
  }

  .now-container {
    display: flex;
    align-items: center;
    gap: 0.5em;
    width: 100%;
    overflow: hidden;
    margin-bottom: 10px;
  }

  #now_wrapper {
    flex: 1;
    overflow: hidden;
    white-space: nowrap;
    position: relative;
  }

  #now_playing {
    display: inline-block;
    white-space: nowrap;
    will-change: transform;
  }

  .scroll #now_playing {
    padding-left: 100%;
    animation: scroll-text 20s linear infinite;
  }

  @keyframes scroll-text {
    from {
      transform: translateX(0);
    }
    to {
      transform: translateX(-100%);
    }
  }
</style>

<main>
  <h1>–ì–æ–≤–Ω–æ–≤–æ–∑ –†–∞–¥–∏–æ</h1>
  <div class="now-container">
    <span id="now_label">–°–µ–π—á–∞—Å –æ—Ç–∫–∞—á–∏–≤–∞–µ—Ç:</span>
    <span id="now_wrapper">
      <span id="now_playing"></span>
    </span>
  </div>
  <audio controls id="a" playsinline></audio>
  <div>
    <button id="play">‚ñ∂Ô∏è –ò–≥—Ä–∞—Ç—å</button>
    <button id="mute">üîá/üîä</button>
  </div>
</main>

<script>
  const a = document.getElementById('a');

  async function start() {
    const sources = [
      '/live/mp4/playlist.m3u8', // CMAF/fMP4
      '/live/ts/playlist.m3u8'   // TS
    ];

    async function probe(pathOrUrl) {
      const u = new URL(pathOrUrl, location.origin); // –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ https
      u.searchParams.set('_', Date.now());           // –¥–æ–±–∞–≤–ª—è–µ–º ?_=...
      console.log('probe ‚Üí', u.toString());          // –≤—Ä–µ–º–µ–Ω–Ω–æ: —É–±–µ–¥–∏—Å—å, —á—Ç–æ –ù–ï–¢ "/?" !
      const r = await fetch(u.toString(), {method: 'HEAD', cache: 'no-store'});
      return r.ok;
    }

    // Safari / iOS ‚Äî –Ω–∞—Ç–∏–≤–Ω—ã–π HLS
    if (a.canPlayType('application/vnd.apple.mpegurl')) {
      for (const src of sources) {
        if (await probe(src)) {
          a.src = src;
          await a.play().catch(() => {
          });
          return;
        }
      }
      console.error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö HLS –ø–ª–µ–π–ª–∏—Å—Ç–æ–≤');
      return;
    }

    // –û—Å—Ç–∞–ª—å–Ω—ã–µ ‚Äî —á–µ—Ä–µ–∑ hls.js
    if (window.Hls && Hls.isSupported()) {
      const hls = new Hls({lowLatencyMode: true, backBufferLength: 10});
      hls.attachMedia(a);

      for (const src of sources) {
        if (!(await probe(src))) continue;
        try {
          hls.loadSource(src);
          await a.play().catch(() => {
          });
          return;
        } catch {
        }
      }
      console.error('–í—Å–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —É–ø–∞–ª–∏');
    }
  }

  document.getElementById('play').onclick = async () => {
    a.muted = false;
    await start();
    await refreshNow();
  };

  document.getElementById('mute').onclick = () => {
    a.muted = !a.muted;
  };

  const wrapper = document.getElementById("now_wrapper");
  const playing = document.getElementById("now_playing");

  async function refreshNow() {
    try {
      const r = await fetch('/live/current_track.json', {cache: 'no-store'});
      if (!r.ok) throw new Error('bad status');
      const j = await r.json();
      playing.textContent = j.title;
    } catch (e) {
    }
  }

  function updateScroll() {
    if (!wrapper || !playing) return;
    wrapper.classList.toggle("scroll", playing.scrollWidth > wrapper.clientWidth);
  }

  // 1) –ò–∑–º–µ–Ω–∏–ª—Å—è —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞ ‚Äî –æ–±–Ω–æ–≤–∏–º (c rAF, —á—Ç–æ–±—ã –Ω–µ –¥—ë—Ä–≥–∞—Ç—å –ø–æ 100 —Ä–∞–∑)
  window.addEventListener('resize', () => requestAnimationFrame(updateScroll));
  // 2) DOM –≥–æ—Ç–æ–≤
  document.addEventListener('DOMContentLoaded', updateScroll);
  // 3) –®—Ä–∏—Ñ—Ç—ã –ø–æ–¥–≥—Ä—É–∑–∏–ª–∏—Å—å ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø–æ–º–µ–Ω—è—é—Ç—Å—è
  if (document.fonts && document.fonts.ready) {
    document.fonts.ready.then(updateScroll).catch(() => {
    });
  }
  // 4) –°–ª–µ–¥–∏–º –∑–∞ —Ä–µ–∞–ª—å–Ω—ã–º –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ä–∞–∑–º–µ—Ä–æ–≤ wrapper
  const ro1 = new ResizeObserver(updateScroll);
  ro1.observe(wrapper);
  // 5) –ò –∑–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ/–ø–µ—Ä–µ–Ω–æ—Å–æ–≤ playing
  const ro2 = new ResizeObserver(updateScroll);
  ro2.observe(playing);

  document.addEventListener('DOMContentLoaded', () => {
    const JSON_URL = '/live/current_track.json';
    const M3U8_URL = '/live/mp4/playlist.m3u8';

    let mediaUrl = null;
    let target = 6;
    let prevSeq = null;

    playing.style.transition = 'opacity .25s ease';
    playing.style.willChange = 'opacity';

    const DELAY_SEGMENTS = 4; // –Ω–∞—á–Ω–∏ —Å 4 (‚âà 24 —Å–µ–∫ –ø—Ä–∏ hls_time=6)

    function fadeSet(txt) {
      if (!txt || txt === playing.textContent) return;
      playing.style.opacity = '0';
      setTimeout(() => {
        playing.textContent = txt;
        playing.style.opacity = '1';
        updateScroll()
      }, 200);
    }

    function pickVariant(masterTxt, baseUrl) {
      const lines = masterTxt.split('\n');
      const variants = [];
      for (let i = 0; i < lines.length; i++) {
        const inf = lines[i];
        if (inf.startsWith('#EXT-X-STREAM-INF')) {
          const bwm = inf.match(/BANDWIDTH=(\d+)/);
          const uri = (lines[i + 1] || '').trim();
          if (uri && !uri.startsWith('#')) {
            variants.push({bw: bwm ? +bwm[1] : 9e12, uri});
          }
        }
      }
      variants.sort((a, b) => a.bw - b.bw);
      const rel = variants[0]?.uri || null;
      if (!rel) return null;
      try {
        return new URL(rel, new URL(baseUrl, location.href)).toString();
      } catch {
        return rel;
      }
    }

    async function ensureMedia() {
      if (mediaUrl) return mediaUrl;
      const r = await fetch(M3U8_URL + '?t=' + performance.now(), {cache: 'no-store'});
      if (!r.ok) throw new Error('master ' + r.status);
      const txt = await r.text();
      // –µ—Å–ª–∏ —ç—Ç–æ —É–∂–µ media‚Äëplaylist (–±–µ–∑ STREAM-INF) ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      if (!/#EXT-X-STREAM-INF/i.test(txt)) {
        mediaUrl = M3U8_URL;
        return mediaUrl;
      }
      mediaUrl = pickVariant(txt, M3U8_URL);
      if (!mediaUrl) throw new Error('no variants in master');
      return mediaUrl;
    }

    async function fetchMeta() {
      const r = await fetch(mediaUrl + '?t=' + performance.now(), {cache: 'no-store'});
      if (!r.ok) throw new Error('media ' + r.status);
      const txt = await r.text();
      const seq = (txt.match(/#EXT-X-MEDIA-SEQUENCE:(\d+)/)?.[1]) | 0;
      const td = +(txt.match(/#EXT-X-TARGETDURATION:(\d+)/)?.[1] || target);
      target = td || target;
      return {seq, target: td};
    }

    async function fetchTitleAndShow() {
      const r = await fetch(JSON_URL + '?t=' + performance.now(), {cache: 'no-store'});
      if (!r.ok) return;
      const j = await r.json();
      const title = (j?.title || '').trim();
      if (title) fadeSet(title);
    }

    async function loop() {
      try {
        await ensureMedia();
        const {seq, target: td} = await fetchMeta();
        if (prevSeq === null) prevSeq = seq;
        if (seq !== prevSeq) {
          prevSeq = seq;
          setTimeout(fetchTitleAndShow, (td * DELAY_SEGMENTS) * 1000);
        }
      } catch (_) {
      }
      setTimeout(loop, target * 1000);
    }

    loop();
  });
</script>
