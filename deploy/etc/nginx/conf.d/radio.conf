server {
    listen 80 default_server;
    server_name _;

    root /var/www/html;
    index index.html player.html;

    # Базовые оптимизации
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Безопасные заголовки
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;

    # ---------- БЕЛЫЙ СПИСОК ЛОКАЦИЙ, которые НЕ редиректим ----------
    # 1) HLS/CMAF потоки
    location ^~ /live/ {
        alias /var/www/hls/;   # важен слэш
        gzip off;
        aio threads;
        sendfile on;
        tcp_nopush on;

        # CORS для плееров
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Origin, Accept, Referer, User-Agent" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;
        add_header Timing-Allow-Origin "*" always;

        if ($request_method = OPTIONS) { return 204; }

        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
            video/mp4 m4s;
            video/mp4 mp4;   # init.mp4 для CMAF
        }

        # Плейлисты — без кэша
        location ~* \.m3u8$ {
            alias /var/www/hls/;
            etag off;
            expires -1;
            add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
            add_header Pragma "no-cache" always;
            add_header Expires "0" always;
        }

        # Сегменты — агрессивный кэш
        location ~* \.(?:ts|m4s|mp4)$ {
            alias /var/www/hls/;
            etag on;
            expires 1h;
            add_header Cache-Control "public, max-age=3600, immutable" always;
            open_file_cache          max=10000 inactive=60s;
            open_file_cache_valid    120s;
            open_file_cache_min_uses 2;
            open_file_cache_errors   on;
            directio 8m;
        }
    }

    # 2) Статика приложения — не редиректим, а просто отдаём
    location ~* \.(?:css|js|mjs|map|woff2?|ttf|otf|eot|svg|png|jpe?g|gif|webp|ico)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        access_log off;
    }

    # 3) Техфайлы
    location = /favicon.ico  { expires 7d;  add_header Cache-Control "public, max-age=604800, immutable" always; }
    location = /robots.txt   { expires 1h;  add_header Cache-Control "public, max-age=3600" always; }
    location = /manifest.json { expires 1h; add_header Cache-Control "public, max-age=3600" always; }

    # ---------- РЕДИРЕКТЫ НА КОРЕНЬ ДЛЯ HTML-МАРШРУТОВ ----------
    location = /index.html  { return 308 /; }
    location = /player.html { return 308 /; }

    # Любой другой путь, КРОМЕ белого списка выше:
    # если это не ровно "/", отправляем на "/"
    location / {
        if ($request_uri != "/") { return 308 /; }

        # Рендерим корень из player.html без кэша и без Set-Cookie
        try_files /player.html =404;
        default_type text/html;
        etag off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        proxy_hide_header Set-Cookie;
    }
}
