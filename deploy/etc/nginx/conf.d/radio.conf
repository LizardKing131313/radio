server {
    listen 80 default_server;
    server_name _;

    root /var/www/html;
    index index.html player.html;

    # Базовые оптимизации
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Безопасные заголовки
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "cross-origin" always;

    # ---------- БЕЛЫЙ СПИСОК ЛОКАЦИЙ, которые НЕ редиректим ----------
    # 1) HLS/CMAF потоки
    location ^~ /live/ {
        alias /var/www/hls/;   # важен слэш
        gzip off;
        aio threads;
        sendfile on;
        tcp_nopush on;

        # HLS плеерам важно уметь докачивать по Range
        add_header Accept-Ranges "bytes" always;

        # CORS для плееров
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Range, Origin, Accept, Referer, User-Agent, Cache-Control" always;
        add_header Access-Control-Expose-Headers "Content-Length, Content-Range" always;
        add_header Timing-Allow-Origin "*" always;

        if ($request_method = OPTIONS) { return 204; }

        types {
            application/vnd.apple.mpegurl m3u8;
            video/mp2t ts;
            video/mp4 mp4 m4s;
        }

        # 1) Плейлисты (.m3u8) — БЕЗ кэша
        location ~* ^/live/(.+\.m3u8)$ {
            alias /var/www/hls/$1;            # Важно: $1 подставляет хвост пути (mp4/playlist.m3u8)
            types { application/vnd.apple.mpegurl m3u8; }
            add_header Access-Control-Allow-Origin "*" always;
            add_header Accept-Ranges "bytes" always;
            add_header Cache-Control "no-store" always;
        }

        # 2) Сегменты (.ts/.m4s/.mp4) — С КЭШЕМ
        location ~* ^/live/(.+\.(ts|m4s|mp4))$ {
            alias /var/www/hls/$1;            # Тот же приём с $1
            types { video/mp2t ts; video/mp4 m4s mp4; }
            add_header Access-Control-Allow-Origin "*" always;
            add_header Accept-Ranges "bytes" always;
            add_header Cache-Control "public, max-age=300, immutable" always;  # ← кэш сегментов
        }

        # 3) Info
        location ~* ^/live/(current_track\.json)$ {
            alias /var/www/hls/$1;
            default_type application/json;

            add_header Access-Control-Allow-Origin "*" always;
            add_header Accept-Ranges "bytes" always;
            add_header Cache-Control "no-store" always;
        }
    }

    # 2) Статика приложения — не редиректим, а просто отдаём
    location ~* \.(?:css|js|mjs|map|woff2?|ttf|otf|eot|svg|png|jpe?g|gif|webp|ico)$ {
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        access_log off;
    }

    # 3) Техфайлы
    location = /favicon.ico  { expires 7d;  add_header Cache-Control "public, max-age=604800, immutable" always; }
    location = /robots.txt   { expires 1h;  add_header Cache-Control "public, max-age=3600" always; }
    location = /manifest.json { expires 1h; add_header Cache-Control "public, max-age=3600" always; }

    # ---------- РЕДИРЕКТЫ НА КОРЕНЬ ДЛЯ HTML-МАРШРУТОВ ----------
    location = /index.html  { return 308 /; }
    location = /player.html { return 308 /; }

    # Любой другой путь, КРОМЕ белого списка выше:
    # если это не ровно "/", отправляем на "/"
    location / {
        if ($request_uri != "/") { return 308 /; }

        # Рендерим корень из player.html без кэша и без Set-Cookie
        try_files /player.html =404;
        default_type text/html;
        etag off;
        add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
        proxy_hide_header Set-Cookie;
    }
}
